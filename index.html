<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>abcjs: Basic Demo</title>
	<script src="https://cdn.jsdelivr.net/npm/abcjs@6.3.0/dist/abcjs-basic-min.js" type="text/javascript"></script>
	<script type="text/javascript">
		var kammerton = 
            "X: 1\n" +
			"M: 4/4\n" +
			"L: 1/4\n" +
			"K: Am\n" +
			"V:1\n" +
            "[V:1][A3]";

		var task = 
            "X: 1\n" +
			"M: 4/4\n" +
			"L: 1/4\n" +
			"K: Em\n" +
			"V:1\n" +
			"V:2 clef=bass octave=-2\n" +
			"[V:1][eBG]\n" +
            "[V:2][eb]";
        
        var solution = 
            "X: 1\n" +
			"M: 4/4\n" +
			"L: 1/4\n" +
			"K: Am\n" +
			"V:1\n" +
            "[V:1]eBGBE";

        var mediaStream;

        var mediaRecorder;

		async function load() {
            document.querySelector(".play").addEventListener("click", play);
            document.querySelector(".playSolution").addEventListener("click", playSolution);
            document.querySelector(".record").addEventListener("click", record);
            document.querySelector(".stop").addEventListener("click", stop);
			ABCJS.renderAbc("paper", task);
            await setupAudio();
		}

        async function setupAudio() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("getUserMedia supported.");
            await navigator.mediaDevices
                .getUserMedia(
                // constraints - only audio needed for this app
                {
                    audio: true,
                },
                )

                // Success callback
                .then((stream) => { mediaStream = stream; })

                // Error callback
                .catch((err) => {
                console.error(`The following getUserMedia error occurred: ${err}`);
                });
            } else {
            console.log("getUserMedia not supported on your browser!");
            }
        }

        let chunks = [];
        function record() {
            mediaRecorder = new MediaRecorder(mediaStream);
            mediaRecorder.start(500);
            console.log(mediaRecorder.state);
            console.log("recorder started");

            mediaRecorder.ondataavailable = (e) => {
                chunks.push(e.data);
                console.log(chunks);
            };
        }
        function stop() {
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
            console.log("recorder stopped");
            mediaRecorder.onstop = (e) => {
                const blob = new Blob(chunks, { type: "audio/ogg; codecs=opus" });
                chunks = [];
                const audioURL = window.URL.createObjectURL(blob);
                const audio = document.querySelector('audio');
                audio.src = audioURL;
            };
        }

        function play() {
            if (ABCJS.synth.supportsAudio()) {
                var abc = kammerton;
                var visualObj = ABCJS.renderAbc("*", abc)[0];

                var midiBuffer = new ABCJS.synth.CreateSynth();
                midiBuffer.init({
                //audioContext: new AudioContext(),
                visualObj: visualObj,
                // sequence: [],
                // millisecondsPerMeasure: 1000,
                // debugCallback: function(message) { console.log(message) },
                options: {
                    // soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" ,
                    // sequenceCallback: function(noteMapTracks, callbackContext) { return noteMapTracks; },
                    // callbackContext: this,
                    // onEnded: function(callbackContext),
                    // pan: [ -0.5, 0.5 ]
                }
                }).then(function (response) {
                console.log(response);
                midiBuffer.prime().then(function (response) {
                    midiBuffer.start();
                });
                }).catch(function (error) {
                console.warn("Audio problem:", error);
                });
            } else {
                document.querySelector(".error").innerHTML = "<div class='audio-error'>Audio is not supported in this browser.</div>";
            }
        }

        function playSolution() {
            if (ABCJS.synth.supportsAudio()) {
                var abc = solution;
                var visualObj = ABCJS.renderAbc("*", abc)[0];

                var midiBuffer = new ABCJS.synth.CreateSynth();
                midiBuffer.init({
                //audioContext: new AudioContext(),
                visualObj: visualObj,
                // sequence: [],
                // millisecondsPerMeasure: 1000,
                // debugCallback: function(message) { console.log(message) },
                options: {
                    // soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" ,
                    // sequenceCallback: function(noteMapTracks, callbackContext) { return noteMapTracks; },
                    // callbackContext: this,
                    // onEnded: function(callbackContext),
                    // pan: [ -0.5, 0.5 ]
                }
                }).then(function (response) {
                console.log(response);
                midiBuffer.prime().then(function (response) {
                    midiBuffer.start();
                });
                }).catch(function (error) {
                console.warn("Audio problem:", error);
                });
            } else {
                document.querySelector(".error").innerHTML = "<div class='audio-error'>Audio is not supported in this browser.</div>";
            }
        }

	</script>
	<script type="module">
import { PitchDetector } from "https://esm.sh/pitchy@4";

function updatePitch(analyserNode, detector, input, sampleRate) {
  analyserNode.getFloatTimeDomainData(input);
  const [pitch, clarity] = detector.findPitch(input, sampleRate);

  document.getElementById("pitch").textContent = `${
    Math.round(pitch * 10) / 10
  } Hz`;
  document.getElementById("clarity").textContent = `${Math.round(
    clarity * 100,
  )} %`;
  window.setTimeout(
    () => updatePitch(analyserNode, detector, input, sampleRate),
    100,
  );
}

document.addEventListener("DOMContentLoaded", () => {
  const audioContext = new window.AudioContext();
  const analyserNode = audioContext.createAnalyser();

  document
    .getElementById("resume-button")
    .addEventListener("click", () => audioContext.resume());

  navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
    audioContext.createMediaStreamSource(stream).connect(analyserNode);
    const detector = PitchDetector.forFloat32Array(analyserNode.fftSize);
    detector.minVolumeDecibels = -20;
    const input = new Float32Array(detector.inputLength);
    updatePitch(analyserNode, detector, input, audioContext.sampleRate);
  });
});
    </script>

</head>
<body onload="load()">
  <header>
    <h1>Proof of Concept</h1>
  </header>
    <button id="resume-button">resume</button>
    <p id="pitch"></p>
    <p id="clarity"></p>

  <button class="play">Play Kammerton</button>
  <div class="error"></div>
  <div class="container">
    <div id="paper"></div>
  </div>

  <button class="record">record</button>
  <button class="stop">stop</button>

  <div>
  <audio controls></audio>
  </div>

  <button class="playSolution">Play Solution</button>
</body>
</html>
